# Cube IDE

## File structure

### Project Explorer

  Apart from usual folders, we have a new LPBAM folder containing function needed to implement the functionality.
  Note that we got a folder called ADC which is the name of our LPBAM Application.

<!-- here we can add a description of what to expect in the various folders -->

![lpbam config](./img/01.png)

Note that `lpbam_adc.h` contains all the functions that needs to be called into `main.c`
We will not call DeInit, Stop and Unlink anyway this is a good trace to see the HAL generated by Cube Mx

```c
/* Exported functions ------------------------------------------------------------------------------------------------*/
/* ADC application initialization */
void MX_ADC_Init(void);

/* ADC application Scenario scenario initialization */
void MX_ADC_Scenario_Init(void);

/* ADC application Scenario scenario de-initialization */
void MX_ADC_Scenario_DeInit(void);

/* ADC application Scenario scenario build */
void MX_ADC_Scenario_Build(void);

/* ADC application Scenario scenario link */
void MX_ADC_Scenario_Link(DMA_HandleTypeDef *hdma);

/* ADC application Scenario scenario unlink */
void MX_ADC_Scenario_UnLink(DMA_HandleTypeDef *hdma);

/* ADC application Scenario scenario start */
void MX_ADC_Scenario_Start(DMA_HandleTypeDef *hdma);

/* ADC application Scenario scenario stop */
void MX_ADC_Scenario_Stop(DMA_HandleTypeDef *hdma);

#endif /* LPBAM_ADC_H */
```
# main.c

Let's start with including the LPBAM Library header file
```c
/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "lpbam_adc.h"
```

We also need `stdio.h` for UART output from ADC

```c
/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */
#include "stdio.h"
/* USER CODE END PTD */
```

Let's also add the two handlers we will use for DMA <!-- need to double check this -->

```c
/* USER CODE BEGIN PV */
DMA_HandleTypeDef *LPBAM_ADC_Scenario_DMAHandlers[2];
/* USER CODE END PV */
```
Now we have to add HAL to enter in Stop2 mode
Let's start with the prototype:
<!--this approach should be reviewed vs standard HAL -->
```c
/* USER CODE BEGIN PFP */
static void Enter_Stop2_Mode(void);
```
And now let's add the definition:

```c
/* USER CODE BEGIN 4 */
static void Enter_Stop2_Mode(void)
{
  /* Enter the system to STOP2 mode */
  __HAL_RCC_PWR_CLK_ENABLE();
  HAL_PWREx_EnterSTOP2Mode(PWR_STOPENTRY_WFI);

  /* Check that the system was resumed from stop 2 */
  if (__HAL_PWR_GET_FLAG(PWR_FLAG_STOPF) == 0U)
  {
    Error_Handler();
  }

  /* Clear stop flag */
  __HAL_PWR_CLEAR_FLAG(PWR_FLAG_STOPF);

  /* Check that stop flag is cleared */
  if (__HAL_PWR_GET_FLAG(PWR_FLAG_STOPF) != 0U)
  {
    Error_Handler();
  }
}
```
Now let's copy the function which are part of `lpbam_adc.h` to initialize LPBAM, build the scenario, link and start

```c
/* USER CODE BEGIN 2 */
     MX_ADC_Init();
  /* LPBAM ADC application InSwitch init */
     MX_ADC_Scenario_Init();
        /* LPBAM ADC application InSwitch build */
     MX_ADC_Scenario_Build();


     LPBAM_ADC_Scenario_DMAHandlers[0U] = &handle_LPDMA1_Channel0;
     LPBAM_ADC_Scenario_DMAHandlers[1U] = &handle_LPDMA1_Channel1;
     /* LPBAM ADC application InSwitch link */
     MX_ADC_Scenario_Link(  LPBAM_ADC_Scenario_DMAHandlers[0U]);


     /* LPBAM ADC application InSwitch start */
     MX_ADC_Scenario_Start(LPBAM_ADC_Scenario_DMAHandlers[0U]);
```
Below `MX_ADC_Scenario_Start` let's place a few functions to furtherly reduce power consumption and move to Stop2 power mode:

```c
HAL_FLASHEx_EnablePowerDown(FLASH_BANK_2);
     /* Configuration of the LPM read mode*/
     HAL_FLASHEx_ConfigLowPowerRead(FLASH_LPM_ENABLE);
    HAL_DBGMCU_DisableDBGStopMode();
    HAL_PWREx_EnterSTOP2Mode(PWR_STOPENTRY_WFI);
```
<!-- check if we need to add debug mx or some macros as well -->

